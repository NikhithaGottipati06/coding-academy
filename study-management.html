<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Management Dashboard</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #1a1a2e;
  --text-secondary: #555;
  --accent: #4361ee;
  --accent-hover: #3a56d4;
  --success: #2ec4b6;
  --warning: #ff9f1c;
  --danger: #e63946;
  --border: #ddd;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --radius: 10px;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

/* Header */
.header {
  background: linear-gradient(135deg, #4361ee, #3a0ca3);
  color: #fff;
  padding: 1.2rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(67,97,238,0.3);
}

.header h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: 0.5px; }

.header-actions { display: flex; gap: 0.8rem; align-items: center; }

.theme-toggle {
  background: rgba(255,255,255,0.15);
  border: none;
  color: #fff;
  padding: 0.5rem 0.9rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  transition: background 0.2s;
}
.theme-toggle:hover { background: rgba(255,255,255,0.25); }

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: var(--card);
  border-bottom: 2px solid var(--border);
  overflow-x: auto;
  scrollbar-width: none;
}
.nav-tabs::-webkit-scrollbar { display: none; }

.nav-tab {
  padding: 0.9rem 1.5rem;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--text-secondary);
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}
.nav-tab:hover { color: var(--accent); background: rgba(67,97,238,0.04); }
.nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* Main Content */
.main { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }

.panel { display: none; }
.panel.active { display: block; }

/* Card */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.5rem;
  margin-bottom: 1.2rem;
}
.card h2 { font-size: 1.15rem; margin-bottom: 1rem; color: var(--text); }

/* Form Controls */
input[type="text"], input[type="time"], select, textarea {
  width: 100%;
  padding: 0.6rem 0.8rem;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.9rem;
  font-family: inherit;
  background: var(--card);
  color: var(--text);
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
textarea { resize: vertical; min-height: 100px; }

.btn {
  padding: 0.55rem 1.1rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { opacity: 0.9; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { opacity: 0.9; }
.btn-sm { padding: 0.35rem 0.7rem; font-size: 0.8rem; }

/* ===================== TASK TRACKER ===================== */
.task-form { display: grid; grid-template-columns: 1fr auto auto auto; gap: 0.6rem; align-items: end; margin-bottom: 1rem; }
.task-form .form-group { display: flex; flex-direction: column; gap: 0.25rem; }
.task-form label { font-size: 0.78rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

.task-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
.filter-btn {
  padding: 0.35rem 0.8rem;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  background: var(--card);
  cursor: pointer;
  font-size: 0.82rem;
  color: var(--text-secondary);
  transition: all 0.2s;
}
.filter-btn.active, .filter-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(67,97,238,0.06); }

.task-list { list-style: none; }
.task-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  border: 1px solid var(--border);
  transition: all 0.2s;
}
.task-item:hover { box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
.task-item.completed .task-text { text-decoration: line-through; opacity: 0.5; }

.task-check {
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid var(--border);
  cursor: pointer;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.task-check:hover { border-color: var(--success); }
.task-item.completed .task-check { background: var(--success); border-color: var(--success); color: #fff; }

.task-text { flex: 1; font-size: 0.95rem; }

.task-tag {
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.tag-math { background: #e8f0fe; color: #1a73e8; }
.tag-science { background: #e6f4ea; color: #137333; }
.tag-english { background: #fce8e6; color: #c5221f; }
.tag-history { background: #fef7e0; color: #b06000; }
.tag-cs { background: #f3e8fd; color: #8430ce; }
.tag-other { background: #f1f3f4; color: #555; }

.priority-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
}
.priority-high { background: var(--danger); }
.priority-medium { background: var(--warning); }
.priority-low { background: var(--success); }

.task-delete {
  background: none; border: none; cursor: pointer; color: #bbb; font-size: 1.1rem;
  padding: 0.2rem; transition: color 0.2s;
}
.task-delete:hover { color: var(--danger); }

.empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.95rem; }

/* ===================== SCHEDULE ===================== */
.schedule-grid {
  display: grid;
  grid-template-columns: 80px repeat(7, 1fr);
  gap: 1px;
  background: var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  font-size: 0.82rem;
}
.schedule-header {
  background: var(--accent);
  color: #fff;
  padding: 0.6rem 0.3rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.8rem;
}
.schedule-time {
  background: var(--card);
  padding: 0.5rem 0.3rem;
  text-align: center;
  font-weight: 500;
  font-size: 0.78rem;
  color: var(--text-secondary);
  display: flex; align-items: center; justify-content: center;
}
.schedule-cell {
  background: var(--card);
  padding: 0.4rem;
  min-height: 48px;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.schedule-cell:hover { background: rgba(67,97,238,0.04); }
.schedule-cell .slot-entry {
  background: rgba(67,97,238,0.12);
  color: var(--accent);
  padding: 0.2rem 0.35rem;
  border-radius: 4px;
  font-size: 0.72rem;
  font-weight: 500;
  margin-bottom: 2px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.schedule-cell .slot-entry .slot-remove {
  background: none; border: none; cursor: pointer; color: var(--danger);
  font-size: 0.7rem; padding: 0; line-height: 1; opacity: 0; transition: opacity 0.15s;
}
.schedule-cell .slot-entry:hover .slot-remove { opacity: 1; }

/* Schedule Modal */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: center; justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.5rem;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}
.modal h3 { margin-bottom: 1rem; font-size: 1.05rem; }
.modal .form-group { margin-bottom: 0.8rem; }
.modal label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-secondary); }
.modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
.btn-cancel { background: var(--border); color: var(--text); }

/* ===================== PROGRESS ===================== */
.progress-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
.progress-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.2rem;
}
.progress-card h3 { font-size: 1rem; margin-bottom: 0.6rem; display: flex; justify-content: space-between; }
.progress-bar-bg {
  height: 12px;
  background: var(--bg);
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}
.progress-bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 0.4s ease;
  background: linear-gradient(90deg, var(--accent), #7209b7);
}
.progress-stats { font-size: 0.82rem; color: var(--text-secondary); }

/* ===================== NOTES ===================== */
.notes-layout { display: grid; grid-template-columns: 200px 1fr; gap: 1rem; min-height: 400px; }
.notes-subjects { list-style: none; }
.notes-subject-btn {
  width: 100%;
  text-align: left;
  padding: 0.65rem 0.9rem;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 8px;
  font-size: 0.9rem;
  color: var(--text-secondary);
  transition: all 0.15s;
  margin-bottom: 0.25rem;
}
.notes-subject-btn:hover { background: rgba(67,97,238,0.06); }
.notes-subject-btn.active { background: var(--accent); color: #fff; font-weight: 500; }

.notes-editor { display: flex; flex-direction: column; gap: 0.6rem; }
.notes-editor textarea { flex: 1; min-height: 300px; font-size: 0.95rem; line-height: 1.7; }
.notes-actions { display: flex; gap: 0.5rem; }
.notes-status { font-size: 0.8rem; color: var(--success); opacity: 0; transition: opacity 0.3s; }
.notes-status.show { opacity: 1; }

/* ===================== POMODORO ===================== */
.pomodoro-container { text-align: center; padding: 1rem 0; }
.timer-display {
  font-size: 5rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: 2px;
  margin: 1.5rem 0;
  color: var(--text);
}
.timer-label {
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}
.timer-controls { display: flex; gap: 0.8rem; justify-content: center; margin: 1.5rem 0; }
.timer-controls .btn { padding: 0.7rem 1.8rem; font-size: 1rem; }

.pomodoro-settings { display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem; }
.pomo-setting { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; }
.pomo-setting label { font-size: 0.78rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }
.pomo-setting input {
  width: 70px; text-align: center; padding: 0.4rem;
  border: 1.5px solid var(--border); border-radius: 8px;
  font-size: 0.9rem; background: var(--card); color: var(--text);
}

.session-counter {
  margin-top: 1.2rem;
  font-size: 0.9rem;
  color: var(--text-secondary);
}
.session-dots { display: flex; gap: 0.4rem; justify-content: center; margin-top: 0.5rem; }
.session-dot {
  width: 14px; height: 14px; border-radius: 50%;
  border: 2px solid var(--accent);
}
.session-dot.filled { background: var(--accent); }

/* ===================== DARK MODE ===================== */
body.dark {
  --bg: #121220;
  --card: #1e1e32;
  --text: #e8e8f0;
  --text-secondary: #a0a0b8;
  --border: #2e2e48;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
}
body.dark input, body.dark select, body.dark textarea {
  background: #16162a;
  color: #e8e8f0;
  border-color: #2e2e48;
}
body.dark .schedule-cell { background: #1e1e32; }
body.dark .schedule-time { background: #1e1e32; }
body.dark .progress-bar-bg { background: #16162a; }
body.dark .filter-btn { background: #16162a; border-color: #2e2e48; color: #a0a0b8; }

/* ===================== RESPONSIVE ===================== */
@media (max-width: 768px) {
  .task-form { grid-template-columns: 1fr 1fr; }
  .schedule-grid { font-size: 0.7rem; grid-template-columns: 55px repeat(7, 1fr); }
  .notes-layout { grid-template-columns: 1fr; }
  .notes-subjects { display: flex; overflow-x: auto; gap: 0.3rem; padding-bottom: 0.5rem; }
  .notes-subject-btn { white-space: nowrap; }
  .timer-display { font-size: 3.5rem; }
  .main { padding: 1rem; }
  .header { padding: 1rem; }
  .header h1 { font-size: 1.1rem; }
}
@media (max-width: 480px) {
  .task-form { grid-template-columns: 1fr; }
  .progress-grid { grid-template-columns: 1fr; }
  .nav-tab { padding: 0.7rem 1rem; font-size: 0.85rem; }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>Study Management Dashboard</h1>
  <div class="header-actions">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">ðŸŒ™</button>
  </div>
</div>

<!-- Navigation Tabs -->
<div class="nav-tabs">
  <button class="nav-tab active" data-tab="tasks">Tasks</button>
  <button class="nav-tab" data-tab="schedule">Schedule</button>
  <button class="nav-tab" data-tab="progress">Progress</button>
  <button class="nav-tab" data-tab="notes">Notes</button>
  <button class="nav-tab" data-tab="pomodoro">Pomodoro</button>
</div>

<!-- Main Content -->
<div class="main">

  <!-- =================== TASKS PANEL =================== -->
  <div id="tasks" class="panel active">
    <div class="card">
      <h2>Task Tracker</h2>
      <div class="task-form">
        <div class="form-group">
          <label>Task</label>
          <input type="text" id="taskInput" placeholder="What do you need to study?">
        </div>
        <div class="form-group">
          <label>Subject</label>
          <select id="taskSubject">
            <option value="math">Math</option>
            <option value="science">Science</option>
            <option value="english">English</option>
            <option value="history">History</option>
            <option value="cs">Computer Science</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select id="taskPriority">
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="addTask()">Add Task</button>
        </div>
      </div>
      <div class="task-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="active">Active</button>
        <button class="filter-btn" data-filter="completed">Completed</button>
        <button class="filter-btn" data-filter="high">High Priority</button>
      </div>
      <ul class="task-list" id="taskList"></ul>
    </div>
  </div>

  <!-- =================== SCHEDULE PANEL =================== -->
  <div id="schedule" class="panel">
    <div class="card">
      <h2>Weekly Study Schedule</h2>
      <div class="schedule-grid" id="scheduleGrid"></div>
    </div>
  </div>

  <!-- =================== PROGRESS PANEL =================== -->
  <div id="progress" class="panel">
    <div class="card">
      <h2>Study Progress</h2>
      <div class="progress-grid" id="progressGrid"></div>
    </div>
  </div>

  <!-- =================== NOTES PANEL =================== -->
  <div id="notes" class="panel">
    <div class="card">
      <h2>Study Notes</h2>
      <div class="notes-layout">
        <ul class="notes-subjects" id="notesSubjects"></ul>
        <div class="notes-editor">
          <textarea id="notesArea" placeholder="Start typing your notes..."></textarea>
          <div class="notes-actions">
            <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
            <span class="notes-status" id="notesStatus">Saved!</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== POMODORO PANEL =================== -->
  <div id="pomodoro" class="panel">
    <div class="card">
      <div class="pomodoro-container">
        <div class="timer-label" id="timerLabel">Focus Time</div>
        <div class="timer-display" id="timerDisplay">25:00</div>
        <div class="timer-controls">
          <button class="btn btn-primary" id="timerStartBtn" onclick="toggleTimer()">Start</button>
          <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
        </div>
        <div class="session-counter">
          <span id="sessionText">Sessions completed: 0</span>
          <div class="session-dots" id="sessionDots"></div>
        </div>
        <div class="pomodoro-settings">
          <div class="pomo-setting">
            <label>Focus (min)</label>
            <input type="number" id="focusTime" value="25" min="1" max="120" onchange="updateTimerSettings()">
          </div>
          <div class="pomo-setting">
            <label>Break (min)</label>
            <input type="number" id="breakTime" value="5" min="1" max="30" onchange="updateTimerSettings()">
          </div>
          <div class="pomo-setting">
            <label>Long Break</label>
            <input type="number" id="longBreakTime" value="15" min="1" max="60" onchange="updateTimerSettings()">
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Schedule Modal -->
<div class="modal-overlay" id="scheduleModal">
  <div class="modal">
    <h3 id="modalTitle">Add Study Slot</h3>
    <div class="form-group">
      <label>Subject</label>
      <input type="text" id="slotSubject" placeholder="e.g. Math - Algebra">
    </div>
    <div class="modal-actions">
      <button class="btn btn-cancel" onclick="closeScheduleModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveScheduleSlot()">Save</button>
    </div>
  </div>
</div>

<script>
// ============================== DATA STORE ==============================
const SUBJECTS = [
  { id: 'math', name: 'Math', color: 'tag-math' },
  { id: 'science', name: 'Science', color: 'tag-science' },
  { id: 'english', name: 'English', color: 'tag-english' },
  { id: 'history', name: 'History', color: 'tag-history' },
  { id: 'cs', name: 'Computer Science', color: 'tag-cs' },
  { id: 'other', name: 'Other', color: 'tag-other' }
];

const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
const TIME_SLOTS = ['8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00'];

function loadData(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) || fallback; }
  catch { return fallback; }
}
function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

let tasks = loadData('study_tasks', []);
let schedule = loadData('study_schedule', {});
let notes = loadData('study_notes', {});
let currentFilter = 'all';
let activeNoteSubject = 'math';

// ============================== TABS ==============================
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
    if (tab.dataset.tab === 'progress') renderProgress();
  });
});

// ============================== THEME ==============================
function toggleTheme() {
  document.body.classList.toggle('dark');
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
  localStorage.setItem('study_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
}
if (loadData('study_theme', null) === '"dark"' || localStorage.getItem('study_theme') === 'dark') {
  document.body.classList.add('dark');
  document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
}

// ============================== TASKS ==============================
function addTask() {
  const input = document.getElementById('taskInput');
  const text = input.value.trim();
  if (!text) { input.focus(); return; }
  tasks.push({
    id: Date.now(),
    text,
    subject: document.getElementById('taskSubject').value,
    priority: document.getElementById('taskPriority').value,
    completed: false,
    createdAt: new Date().toISOString()
  });
  saveData('study_tasks', tasks);
  input.value = '';
  input.focus();
  renderTasks();
}

document.getElementById('taskInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addTask();
});

function toggleTask(id) {
  const task = tasks.find(t => t.id === id);
  if (task) task.completed = !task.completed;
  saveData('study_tasks', tasks);
  renderTasks();
}

function deleteTask(id) {
  tasks = tasks.filter(t => t.id !== id);
  saveData('study_tasks', tasks);
  renderTasks();
}

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderTasks();
  });
});

function renderTasks() {
  const list = document.getElementById('taskList');
  let filtered = tasks;
  if (currentFilter === 'active') filtered = tasks.filter(t => !t.completed);
  else if (currentFilter === 'completed') filtered = tasks.filter(t => t.completed);
  else if (currentFilter === 'high') filtered = tasks.filter(t => t.priority === 'high');

  if (filtered.length === 0) {
    list.innerHTML = '<div class="empty-state">No tasks yet. Add your first study task above!</div>';
    return;
  }

  // Sort: incomplete first, then by priority (high > medium > low)
  const pOrder = { high: 0, medium: 1, low: 2 };
  filtered.sort((a, b) => {
    if (a.completed !== b.completed) return a.completed ? 1 : -1;
    return pOrder[a.priority] - pOrder[b.priority];
  });

  list.innerHTML = filtered.map(t => {
    const subj = SUBJECTS.find(s => s.id === t.subject) || SUBJECTS[5];
    return `<li class="task-item ${t.completed ? 'completed' : ''}">
      <div class="task-check" onclick="toggleTask(${t.id})">${t.completed ? 'âœ“' : ''}</div>
      <span class="priority-dot priority-${t.priority}" title="${t.priority} priority"></span>
      <span class="task-text">${escHtml(t.text)}</span>
      <span class="task-tag ${subj.color}">${subj.name}</span>
      <button class="task-delete" onclick="deleteTask(${t.id})" title="Delete">âœ•</button>
    </li>`;
  }).join('');
}

function escHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ============================== SCHEDULE ==============================
let modalDay = null, modalTime = null;

function buildScheduleGrid() {
  const grid = document.getElementById('scheduleGrid');
  let html = '<div class="schedule-header">Time</div>';
  DAYS.forEach(d => html += `<div class="schedule-header">${d}</div>`);

  TIME_SLOTS.forEach(time => {
    html += `<div class="schedule-time">${time}</div>`;
    DAYS.forEach(day => {
      const key = `${day}_${time}`;
      const entries = schedule[key] || [];
      const entriesHtml = entries.map((e, i) =>
        `<div class="slot-entry"><span>${escHtml(e)}</span><button class="slot-remove" onclick="removeSlot('${key}',${i})">âœ•</button></div>`
      ).join('');
      html += `<div class="schedule-cell" onclick="openScheduleModal('${day}','${time}')">${entriesHtml}</div>`;
    });
  });
  grid.innerHTML = html;
}

function openScheduleModal(day, time) {
  modalDay = day; modalTime = time;
  document.getElementById('modalTitle').textContent = `${day} at ${time}`;
  document.getElementById('slotSubject').value = '';
  document.getElementById('scheduleModal').classList.add('show');
  document.getElementById('slotSubject').focus();
}

function closeScheduleModal() {
  document.getElementById('scheduleModal').classList.remove('show');
}

document.getElementById('slotSubject').addEventListener('keydown', e => {
  if (e.key === 'Enter') saveScheduleSlot();
  if (e.key === 'Escape') closeScheduleModal();
});

document.getElementById('scheduleModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeScheduleModal();
});

function saveScheduleSlot() {
  const subj = document.getElementById('slotSubject').value.trim();
  if (!subj) return;
  const key = `${modalDay}_${modalTime}`;
  if (!schedule[key]) schedule[key] = [];
  schedule[key].push(subj);
  saveData('study_schedule', schedule);
  closeScheduleModal();
  buildScheduleGrid();
}

function removeSlot(key, index) {
  event.stopPropagation();
  if (schedule[key]) {
    schedule[key].splice(index, 1);
    if (schedule[key].length === 0) delete schedule[key];
    saveData('study_schedule', schedule);
    buildScheduleGrid();
  }
}

// ============================== PROGRESS ==============================
function renderProgress() {
  const grid = document.getElementById('progressGrid');
  const subjectTasks = {};

  SUBJECTS.forEach(s => {
    subjectTasks[s.id] = { total: 0, completed: 0 };
  });

  tasks.forEach(t => {
    if (subjectTasks[t.subject]) {
      subjectTasks[t.subject].total++;
      if (t.completed) subjectTasks[t.subject].completed++;
    }
  });

  grid.innerHTML = SUBJECTS.filter(s => subjectTasks[s.id].total > 0).map(s => {
    const data = subjectTasks[s.id];
    const pct = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
    return `<div class="progress-card">
      <h3><span>${s.name}</span><span>${pct}%</span></h3>
      <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
      <div class="progress-stats">${data.completed} of ${data.total} tasks completed</div>
    </div>`;
  }).join('') || '<div class="empty-state">Add tasks with subjects to see your progress here.</div>';
}

// ============================== NOTES ==============================
function renderNotesSubjects() {
  const list = document.getElementById('notesSubjects');
  list.innerHTML = SUBJECTS.map(s =>
    `<li><button class="notes-subject-btn ${s.id === activeNoteSubject ? 'active' : ''}" onclick="switchNote('${s.id}')">${s.name}</button></li>`
  ).join('');
  document.getElementById('notesArea').value = notes[activeNoteSubject] || '';
}

function switchNote(subjectId) {
  // Auto-save current note before switching
  notes[activeNoteSubject] = document.getElementById('notesArea').value;
  saveData('study_notes', notes);
  activeNoteSubject = subjectId;
  renderNotesSubjects();
}

function saveNotes() {
  notes[activeNoteSubject] = document.getElementById('notesArea').value;
  saveData('study_notes', notes);
  const status = document.getElementById('notesStatus');
  status.classList.add('show');
  setTimeout(() => status.classList.remove('show'), 2000);
}

// Auto-save notes on input (debounced)
let notesSaveTimeout;
document.getElementById('notesArea').addEventListener('input', () => {
  clearTimeout(notesSaveTimeout);
  notesSaveTimeout = setTimeout(saveNotes, 1000);
});

// ============================== POMODORO ==============================
let timerInterval = null;
let timerRunning = false;
let isBreak = false;
let timeLeft = 25 * 60;
let sessionsCompleted = loadData('study_pomo_sessions', 0);

function updateTimerSettings() {
  if (!timerRunning) {
    const focusMin = parseInt(document.getElementById('focusTime').value) || 25;
    timeLeft = (isBreak ? (parseInt(document.getElementById('breakTime').value) || 5) : focusMin) * 60;
    updateTimerDisplay();
  }
}

function updateTimerDisplay() {
  const min = Math.floor(timeLeft / 60);
  const sec = timeLeft % 60;
  document.getElementById('timerDisplay').textContent =
    String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
}

function toggleTimer() {
  if (timerRunning) {
    pauseTimer();
  } else {
    startTimer();
  }
}

function startTimer() {
  timerRunning = true;
  document.getElementById('timerStartBtn').textContent = 'Pause';
  document.getElementById('timerStartBtn').classList.remove('btn-primary');
  document.getElementById('timerStartBtn').classList.add('btn-success');

  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerRunning = false;
      document.getElementById('timerStartBtn').textContent = 'Start';
      document.getElementById('timerStartBtn').classList.remove('btn-success');
      document.getElementById('timerStartBtn').classList.add('btn-primary');

      if (!isBreak) {
        sessionsCompleted++;
        saveData('study_pomo_sessions', sessionsCompleted);
        renderSessionDots();
        // Switch to break
        isBreak = true;
        const breakMin = (sessionsCompleted % 4 === 0)
          ? (parseInt(document.getElementById('longBreakTime').value) || 15)
          : (parseInt(document.getElementById('breakTime').value) || 5);
        timeLeft = breakMin * 60;
        document.getElementById('timerLabel').textContent = sessionsCompleted % 4 === 0 ? 'Long Break' : 'Short Break';
      } else {
        // Switch to focus
        isBreak = false;
        timeLeft = (parseInt(document.getElementById('focusTime').value) || 25) * 60;
        document.getElementById('timerLabel').textContent = 'Focus Time';
      }
      // Alert
      try { new Audio('data:audio/wav;base64,UklGRlgFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTQFAAB/f39/f39/f39/f3+AgICBgYKCg4OEhIWFhoaHh4iIiYmKiouLjIyNjY6Oj4+QkJGRkpKTk5SUlZWWlpeXmJiZmZqam5ucnJ2dnp6fn6CgoaGioqOjpKSlpaamp6eoqKmpqqqqq6ysra2urq+vsLCxsbKys7O0tLW1tra3t7i4ubm6uru7vLy9vb6+v7/AwMHBwsLDw8TExcXGxsfHyMjJycrKy8vMzM3Nzs7Pz9DR0dLS09PU1NXV1tfX2NjZ2drb29zc3d3e3+Dg4eLi4+Tl5ebn6Onp6uvs7e3u7/Dx8fLz9PX19vf4+fr7/P3+').play(); } catch(e) {}
      updateTimerDisplay();
      return;
    }
    updateTimerDisplay();
  }, 1000);
}

function pauseTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  document.getElementById('timerStartBtn').textContent = 'Start';
  document.getElementById('timerStartBtn').classList.remove('btn-success');
  document.getElementById('timerStartBtn').classList.add('btn-primary');
}

function resetTimer() {
  pauseTimer();
  isBreak = false;
  timeLeft = (parseInt(document.getElementById('focusTime').value) || 25) * 60;
  document.getElementById('timerLabel').textContent = 'Focus Time';
  updateTimerDisplay();
}

function renderSessionDots() {
  document.getElementById('sessionText').textContent = `Sessions completed: ${sessionsCompleted}`;
  const dots = document.getElementById('sessionDots');
  const count = Math.min(sessionsCompleted, 8);
  dots.innerHTML = Array.from({ length: count }, () => '<div class="session-dot filled"></div>').join('') +
    Array.from({ length: Math.max(0, 4 - (count % 4 === 0 && count > 0 ? 4 : count % 4)) }, () => '<div class="session-dot"></div>').join('');
}

// ============================== INIT ==============================
renderTasks();
buildScheduleGrid();
renderProgress();
renderNotesSubjects();
updateTimerDisplay();
renderSessionDots();
</script>
</body>
</html>
